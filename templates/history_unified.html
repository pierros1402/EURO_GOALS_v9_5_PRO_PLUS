<!-- ============================================================
     EURO_GOALS v9.6.3 PRO+ â€” History+ Weekly Extended View
     Rolling 15-day plan (FlashScore/SofaScore), Standings & H2H
============================================================ -->
<section class="history-section bg-neutral-900/70 text-gray-100 rounded-xl shadow p-4 backdrop-blur-md">

  <!-- Header / Controls -->
  <header class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between mb-3">
    <div>
      <h2 class="text-xl font-semibold text-sky-400 mb-1">ğŸ“… Î Î»Î¬Î½Î¿ Î‘Î³ÏÎ½Ï‰Î½ (15Î®Î¼ÎµÏÎ¿)</h2>
      <p class="text-gray-400 text-sm">
        Î ÏÎ¿Î²Î¿Î»Î®: 7 Î·Î¼Î­ÏÎµÏ‚ Ï€ÏÎ¹Î½ â†’ ÏƒÎ®Î¼ÎµÏÎ± â†’ 7 Î·Î¼Î­ÏÎµÏ‚ Î¼ÎµÏ„Î¬ â€¢ ÎœÎµ Ï†Î¯Î»Ï„ÏÎ± Ï€Î·Î³Î®Ï‚ & Î´Î¹Î¿ÏÎ³Î¬Î½Ï‰ÏƒÎ·Ï‚
      </p>
    </div>

    <div class="flex flex-wrap items-center gap-2">
      <select id="sourceSelect" class="bg-gray-800 text-gray-200 text-xs px-2 py-1 rounded border border-gray-700">
        <option value="all">ÎŒÎ»ÎµÏ‚ Î¿Î¹ Ï€Î·Î³Î­Ï‚</option>
        <option value="flashscore">FlashScore</option>
        <option value="sofascore">SofaScore</option>
      </select>

      <select id="leagueSelect" class="bg-gray-800 text-gray-200 text-xs px-2 py-1 rounded border border-gray-700 min-w-[220px]">
        <option value="all">ÎŒÎ»ÎµÏ‚ Î¿Î¹ Î”Î¹Î¿ÏÎ³Î±Î½ÏÏƒÎµÎ¹Ï‚</option>
      </select>

      <div class="flex items-center gap-1">
        <button id="prevWeek" class="px-3 py-1 bg-gray-700 text-gray-200 rounded hover:bg-gray-600 transition">â—€ Î ÏÎ¿Î·Î³.</button>
        <button id="resetToday" class="px-3 py-1 bg-sky-700 text-white rounded hover:bg-sky-600 transition">Î£Î®Î¼ÎµÏÎ±</button>
        <button id="nextWeek" class="px-3 py-1 bg-gray-700 text-gray-200 rounded hover:bg-gray-600 transition">Î•Ï€ÏŒÎ¼. â–¶</button>
      </div>

      <button id="exportCSV" class="text-xs px-3 py-1 bg-emerald-700 text-white rounded hover:bg-emerald-600 transition">
        â¬‡ Î•Î¾Î±Î³Ï‰Î³Î® CSV
      </button>
    </div>
  </header>

  <!-- Grid: Schedule & Standings -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
    <!-- Schedule -->
    <div class="md:col-span-2 border-t border-gray-800 pt-2">
      <div id="scheduleInfo" class="text-xs text-gray-400 mb-2"></div>
      <div id="scheduleContainer" class="space-y-3" style="max-height: 620px; overflow-y: auto;">
        <p class="text-center text-gray-400">Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½â€¦</p>
      </div>
    </div>

    <!-- Standings -->
    <aside class="md:col-span-1 border-t border-gray-800 pt-2">
      <h3 class="text-lg font-semibold text-green-400 mb-2">ğŸ† Î’Î±Î¸Î¼Î¿Î»Î¿Î³Î¯Î±</h3>
      <div id="standingsContainer" class="rounded border border-gray-800">
        <table class="w-full text-sm border-collapse">
          <thead class="bg-gray-800 text-green-300">
            <tr>
              <th class="p-2 text-left">#</th>
              <th class="p-2 text-left">ÎŸÎ¼Î¬Î´Î±</th>
              <th class="p-2 text-center">Î‘Î³.</th>
              <th class="p-2 text-right">Î’.</th>
            </tr>
          </thead>
          <tbody id="standingsBody" class="divide-y divide-gray-700 text-gray-200">
            <tr><td colspan="4" class="p-3 text-center text-gray-400">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Î´Î¹Î¿ÏÎ³Î¬Î½Ï‰ÏƒÎ·â€¦</td></tr>
          </tbody>
        </table>
      </div>
    </aside>
  </div>

  <footer class="text-xs text-gray-500 mt-3 flex items-center justify-between">
    <span>* Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î· Î±Î½Î±Î½Î­Ï‰ÏƒÎ· ÎºÎ¬Î¸Îµ 60â€³.</span>
    <span id="lastUpdate" class="text-gray-400"></span>
  </footer>
</section>

<!-- ==============================
     Scripts (inline, no external deps)
============================== -->
<script>
  // --- Controls / State
  const sourceSel = document.getElementById('sourceSelect');
  const leagueSel = document.getElementById('leagueSelect');
  const prevBtn   = document.getElementById('prevWeek');
  const nextBtn   = document.getElementById('nextWeek');
  const resetBtn  = document.getElementById('resetToday');
  const lastUpdEl = document.getElementById('lastUpdate');
  const infoEl    = document.getElementById('scheduleInfo');
  const schedEl   = document.getElementById('scheduleContainer');
  const standTBody= document.getElementById('standingsBody');

  let weekOffset = 0;          // 0 = Ï„ÏÎ­Ï‡Î¿Î½ 15Î®Î¼ÎµÏÎ¿, -1 Ï€Î¯ÏƒÏ‰, +1 Î¼Ï€ÏÎ¿ÏƒÏ„Î¬
  let currentItems = [];       // Î³Î¹Î± export

  // --- Helpers
  function fmtDate(ts) {
    if (!ts) return '-';
    const d = new Date(Number(ts) * 1000);
    const date = d.toLocaleDateString('el-GR', { weekday:'long', day:'2-digit', month:'2-digit' });
    const time = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    return `${date} ${time}`;
  }
  function dayKey(ts) {
    const d = new Date(Number(ts) * 1000);
    return d.toLocaleDateString('el-GR', { weekday:'long', day:'2-digit', month:'2-digit' });
  }
  function csvEscape(v){ return String(v ?? '').replace(/"/g,'""'); }

  // --- Load leagues (with safe fallback)
  async function loadLeagues() {
    leagueSel.innerHTML = `<option value="all">ÎŒÎ»ÎµÏ‚ Î¿Î¹ Î”Î¹Î¿ÏÎ³Î±Î½ÏÏƒÎµÎ¹Ï‚</option>`;
    try {
      const r = await fetch('/api/leagues');
      if (!r.ok) throw new Error();
      const data = await r.json();
      const leagues = data.leagues || [];
      if (leagues.length) {
        leagues.forEach(l => {
          const opt = document.createElement('option');
          opt.value = l.name || l.id || '';
          opt.textContent = l.name || l.id || '';
          leagueSel.appendChild(opt);
        });
        return;
      }
      throw new Error();
    } catch {
      // Fallback standard set
      [
        "Premier League","La Liga","Serie A","Bundesliga",
        "Ligue 1","Eredivisie","Primeira Liga","Super League Greece"
      ].forEach(name=>{
        const opt=document.createElement('option'); opt.value=name; opt.textContent=name; leagueSel.appendChild(opt);
      });
    }
  }

  // --- Build H2H/Forms row (collapsible)
  function h2hSkeletonRow(match, idx) {
    const rowId = `h2h_${idx}`;
    return `
      <tr class="bg-neutral-900/40">
        <td colspan="4" class="p-2">
          <div id="${rowId}" class="rounded border border-gray-800 p-2">
            <div class="text-xs text-gray-400">Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Ï€ÏÎ¿ÏŠÏƒÏ„Î¿ÏÎ¯Î±Ï‚â€¦</div>
          </div>
        </td>
      </tr>
    `;
  }

  async function loadH2H(rowEl, match) {
    const box = rowEl.querySelector('div[id^="h2h_"]');
    if (!box) return;
    const { home_team: home, away_team: away, league } = match;

    try {
      const r = await fetch(`/api/h2h?home=${encodeURIComponent(home)}&away=${encodeURIComponent(away)}&league=${encodeURIComponent(league||'')}`);
      if (!r.ok) throw new Error();
      const data = await r.json();
      const h2h = (data.h2h || []).slice(0,5);
      const homeForm = (data.home_form || []).slice(0,5);
      const awayForm = (data.away_form || []).slice(0,5);

      const pill = (res) => {
        if (res === 'W') return '<span class="status-pill bg-green">N</span>';
        if (res === 'L') return '<span class="status-pill bg-red">H</span>';
        return '<span class="status-pill bg-gray">I</span>';
      };

      box.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 text-sm">
          <div>
            <div class="font-semibold text-sky-400 mb-1">âš”ï¸ ÎœÎµÏ„Î±Î¾Ï Ï„Î¿Ï…Ï‚ (5)</div>
            <table class="w-full text-xs">
              ${h2h.map(m=>`
                <tr class="border-b border-gray-800">
                  <td class="p-1">${m.date || '-'}</td>
                  <td class="p-1">${m.home} vs ${m.away}</td>
                  <td class="p-1 text-right">${m.score || '-'}</td>
                </tr>
              `).join('')}
            </table>
          </div>
          <div>
            <div class="font-semibold text-emerald-400 mb-1">ğŸ  ${home} (Home â€¢ 5)</div>
            <table class="w-full text-xs">
              ${homeForm.map(m=>`
                <tr class="border-b border-gray-800">
                  <td class="p-1">${m.date || '-'}</td>
                  <td class="p-1">${m.opponent || '-'}</td>
                  <td class="p-1 text-right">${m.score || '-'}</td>
                  <td class="p-1 text-right">${pill(m.result||'-')}</td>
                </tr>
              `).join('')}
            </table>
          </div>
          <div>
            <div class="font-semibold text-amber-400 mb-1">ğŸšŒ ${away} (Away â€¢ 5)</div>
            <table class="w-full text-xs">
              ${awayForm.map(m=>`
                <tr class="border-b border-gray-800">
                  <td class="p-1">${m.date || '-'}</td>
                  <td class="p-1">${m.opponent || '-'}</td>
                  <td class="p-1 text-right">${m.score || '-'}</td>
                  <td class="p-1 text-right">${pill(m.result||'-')}</td>
                </tr>
              `).join('')}
            </table>
          </div>
        </div>
      `;
    } catch {
      box.innerHTML = `<div class="text-xs text-red-400">âš  Î”ÎµÎ½ Î®Ï„Î±Î½ Î´Ï…Î½Î±Ï„Î® Î· Ï†ÏŒÏÏ„Ï‰ÏƒÎ· Ï€ÏÎ¿ÏŠÏƒÏ„Î¿ÏÎ¯Î±Ï‚ (H2H/Forms).</div>`;
    }
  }

  // --- Render schedule grouped by day
  function renderSchedule(items) {
    currentItems = items.slice(); // keep for CSV
    if (!items.length) {
      schedEl.innerHTML = `<p class="text-center text-gray-400">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î±.</p>`;
      return;
    }
    // group by day
    const grouped = items.reduce((acc, m) => {
      const key = dayKey(m.date || m.ts);
      if (!acc[key]) acc[key] = [];
      acc[key].push(m);
      return acc;
    }, {});
    const days = Object.keys(grouped);

    schedEl.innerHTML = days.map(day => {
      const list = grouped[day];
      const rows = list.map((m, i) => `
        <tbody class="match-block">
          <tr class="hover:bg-neutral-800/60 transition cursor-pointer" data-match-idx="${i}" data-day="${day}">
            <td class="p-2 w-[36%]">${m.home_team || m.home || '-'}</td>
            <td class="p-2 text-center text-gray-400">vs</td>
            <td class="p-2 w-[36%]">${m.away_team || m.away || '-'}</td>
            <td class="p-2 text-right">${m.score || '-'}</td>
          </tr>
          ${h2hSkeletonRow(m, `${day}_${i}`)}
        </tbody>
      `).join('');
      return `
        <div class="mb-3 rounded border border-gray-800">
          <div class="px-2 py-1 bg-gray-800 text-sky-400 text-sm font-semibold sticky top-0">${day}</div>
          <table class="w-full text-sm">${rows}</table>
        </div>
      `;
    }).join('');

    // attach expand/collapse for H2H
    schedEl.querySelectorAll('tr[data-match-idx]').forEach(tr=>{
      tr.addEventListener('click', ()=>{
        const tbody = tr.parentElement;
        const h2hRow = tbody.querySelector('tr.bg-neutral-900/40');
        if (!h2hRow) return;
        const opened = h2hRow.style.display !== 'none';
        // collapse others in this day
        tbody.parentElement.querySelectorAll('tr.bg-neutral-900/40').forEach(r=>r.style.display='none');
        if (!opened) {
          h2hRow.style.display = '';
          // figure out the match object again
          const day = tr.getAttribute('data-day');
          const idx = Number(tr.getAttribute('data-match-idx'));
          const list = grouped[day] || [];
          const m = list[idx];
          loadH2H(h2hRow, {
            league: m.league,
            home_team: m.home_team || m.home,
            away_team: m.away_team || m.away,
            date: m.date || m.ts
          });
        }
      });
      // default hidden
      const h2hRow = tr.parentElement.querySelector('tr.bg-neutral-900/40');
      if (h2hRow) h2hRow.style.display = 'none';
    });
  }

  // --- Load schedule (15days) & standings
  async function loadData() {
    const source = sourceSel.value;
    const league = leagueSel.value;
    infoEl.textContent = 'Î¦ÏŒÏÏ„Ï‰ÏƒÎ·â€¦';
    try {
      // schedule
      const url = `/api/history?source=${encodeURIComponent(source)}&league=${encodeURIComponent(league)}&range=15days&offset=${weekOffset}`;
      const r = await fetch(url);
      const data = await r.json();
      const items = data.history || [];
      renderSchedule(items);
      lastUpdEl.textContent = 'Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î± ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ·: ' + new Date().toLocaleTimeString();
      infoEl.textContent = `Î£ÏÎ½Î¿Î»Î¿: ${items.length} Î±Î³ÏÎ½ÎµÏ‚ â€¢ Offset ÎµÎ²Î´Î¿Î¼Î¬Î´Î±Ï‚: ${weekOffset}`;
    } catch {
      schedEl.innerHTML = `<p class="text-center text-red-400">âš  Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ Ï€Î»Î¬Î½Î¿Ï….</p>`;
      infoEl.textContent = '';
    }

    // standings
    try {
      if (league && league !== 'all') {
        const s = await fetch(`/api/standings?league=${encodeURIComponent(league)}`);
        const sd = await s.json();
        const rows = (sd.standings || []).map(t=>`
          <tr>
            <td class="p-2">${t.rank ?? '-'}</td>
            <td class="p-2">${t.team ?? '-'}</td>
            <td class="p-2 text-center">${t.played ?? '-'}</td>
            <td class="p-2 text-right">${t.points ?? '-'}</td>
          </tr>
        `).join('');
        standTBody.innerHTML = rows || `<tr><td colspan="4" class="p-3 text-center text-gray-400">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î²Î±Î¸Î¼Î¿Î»Î¿Î³Î¹ÎºÎ¬ Î´ÎµÎ´Î¿Î¼Î­Î½Î±.</td></tr>`;
      } else {
        standTBody.innerHTML = `<tr><td colspan="4" class="p-3 text-center text-gray-400">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Î´Î¹Î¿ÏÎ³Î¬Î½Ï‰ÏƒÎ·â€¦</td></tr>`;
      }
    } catch {
      standTBody.innerHTML = `<tr><td colspan="4" class="p-3 text-center text-red-400">âš  Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ Î²Î±Î¸Î¼Î¿Î»Î¿Î³Î¯Î±Ï‚.</td></tr>`;
    }
  }

  // --- Export CSV (currentItems)
  document.getElementById('exportCSV').addEventListener('click', ()=>{
    if (!currentItems.length) { alert('Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î³Î¹Î± ÎµÎ¾Î±Î³Ï‰Î³Î®.'); return; }
    const rows = [
      ['Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±','Î”Î¹Î¿ÏÎ³Î¬Î½Ï‰ÏƒÎ·','Home','Away','Î‘Ï€Î¿Ï„Î­Î»ÎµÏƒÎ¼Î±'],
      ...currentItems.map(m=>[
        m.date || m.ts || '',
        m.league || '',
        m.home_team || m.home || '',
        m.away_team || m.away || '',
        m.score || ''
      ])
    ];
    const csv = rows.map(r=>r.map(csvEscape).map(v=>`"${v}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'eurogoals_history_15days.csv'; a.click();
    URL.revokeObjectURL(url);
  });

  // --- Events
  sourceSel.addEventListener('change', loadData);
  leagueSel.addEventListener('change', loadData);
  prevBtn.addEventListener('click', ()=>{ weekOffset--; loadData(); });
  nextBtn.addEventListener('click', ()=>{ weekOffset++; loadData(); });
  resetBtn.addEventListener('click', ()=>{ weekOffset=0; loadData(); });

  // --- Init
  (async function init() {
    await loadLeagues();
    await loadData();
    setInterval(loadData, 60000);
  })();
</script>
